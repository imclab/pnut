<div id="topics" class="moduleBox">
<h2>Разделы</h2>
<ul>
	<li id="troot"><a href="#">Корень</a>

	<ul>
		<? foreach ($this->topics as $topic): ?>
		<? if ($this->topics->getStep() > 0): ?><?=str_repeat("<ul>", $this->topics->getStep())?><? elseif ($this->topics->getStep() < 0): ?><?=str_repeat("</li></ul></li>", -($this->topics->getStep()))?><? elseif (!$this->topics->isFirst()): ?></li><? endif ?>
		<li id="t<?=$topic->getId()?>"<? if ($topic->getId() == $this->topicId): ?> class="active"<?endif?>>
			<a href="<?=$this->pathTo("Admin_Topic", "default", array( 'id' => $topic->getId() ))?>" title="<?=$topic->name?>"><?=$topic->title?></a>
		<? endforeach ?>
		<? if ($this->topics->getLevel() > 1): ?><?=str_repeat("</li></ul>", $this->topics->getLevel()-1)?><? endif ?>
		</li>
	</ul>

	</li>
</ul>
<h2><a href="<?=$this->pathTo("Topic", "trashcan")?>">Корзина</a></h2>
</div>

<ol id="topicsMenu" class="contextMenu">
	<li class="editTopic"><a title="Открыть полную форму правки раздела" href="#edit">Изменить</a></li>
	<li class="newArticle"><a title="Создать новую статью в этом разделе" href="#write">Написать</a></li>
	<li class="newTopic"><a title="Создать подраздел в этом разделе" href="#create">Создать</a></li>
	<li class="copyBuffer"><a title="Переименовать раздел без перезагузки страницы" href="#rename">Переименовать</a></li>
	<li class="cutBuffer separator"><a title="Вырезать раздел для вставки в другой в качестве подраздела" href="#cut">Вырезать</a></li>
	<li class="pasteBuffer disabled"><a title="Поместить вырезанный раздел в этот" href="#paste">Вставить</a></li>
	<li class="removeTopic separator"><a title="Удалить раздел" href="#remove">Удалить</a></li>
</ol>

<ol id="rootTopicMenu" class="contextMenu">
	<li class="newTopic"><a title="Создать подраздел в этом разделе" href="#create">Создать</a></li>
	<li class="pasteBuffer disabled separator"><a title="Поместить вырезанный раздел в этот" href="#paste">Вставить</a></li>
</ol>

<form id="question" class="popupForm" action="#">
	<h3>&#8963; вопрос</h3>
	<ol>
		<li>&nbsp;</li>
		<li><input type="reset" value="Нет" class="reset" /><input type="submit" class="submit" value="Да" /></li>
	</ol>
</form>

<form id="renameTopic" class="popupForm" action="#">
	<h3>&#8963; переименовать</h3>
	<ol>
		<li><label for="ttitle">Заголовок</label><input type="text" value="" id="ttitle" name="title" /></li>
		<li><label for="tname">Название</label><input type="text" value="" id="tname" name="name" /></li>
		<li><input type="reset" value="Отмена" class="reset" /><input type="submit" value="ОК" class="submit" /></li>
	</ol>
</form>

<div id="errorForm" class="errorForm popupForm">
	<h3>Ошибка!</h3>
	<p>&nbsp;</p>
</div>

<script type="text/javascript">
//<![CDATA[
var cut_topic_id;

function ask_question(question, $obj, href, ajaxaction)
{
	var $form = $('#question');
	var pos = $obj.offset();
	pos.top += $obj.height();
	$form.data("ajaxaction", ajaxaction).attr("action", href).css(pos).find("ol li:first-child").text(question).end().show();
}

function run_form(e)
{
	var data = new Object();
	var $form = $(e.target);
	var ok_handler = $form.data("ajaxaction");
	$form.hide().find(":input[name]").each(function(){ data[this.name] = this.value; });
	data.ajax = true;
	$.getJSON($form.attr("action"), data, function (result) {
		if (result.state != "failed" && ok_handler)
			ok_handler(result);
		else
			error_form(result.error, $form);
	});
	return false;
}

function error_form(errmsg, $obj)
{
	var $form = $("#errorForm");
	var pos = $obj.offset();
	pos.top += $obj.height();
	$form.css(pos).find("p").text(errmsg).end().fadeIn("fast", function(){setTimeout("$('#errorForm').fadeOut('slow')", 5000)});
}

function rename_topic(result)
{
	var $item = $("#topics li#t"+result.id).find("a:first-child");
	$item.attr("title", result.name).text(result.title);
}

function remove_topic(result)
{
	var $item = $("#topics li#t"+result.id);
	$item.fadeOut("normal", function(){$(this).remove()});
}

function reorder_topic(e, ui)
{
	var $item = $(ui.item);
	var $targ = $(ui.item).prev();
	var place = "after";
	if (!$targ.length)
	{
		$targ = $(ui.item).next();
		place = "before";
	}

	var targid = $targ.attr('id').substring(1);
	var itemid = $item.attr('id').substring(1);
	$(e.target).sortable('cancel');


	$.getJSON("<?=$this->pathTo('Topic', 'reorder')?>/"+itemid+"/"+place+"/"+targid, { ajax: true }, function (result) {
		var $item = $("#t"+result.id);
		var $targ = $("#t"+result.target_id);

		if (result.state != "failed")
		{
			switch (result.place)
			{
			case 'before':
				$item.insertBefore($targ);
				break;
			case 'after':
				$item.insertAfter($targ);
				break;
			}
		}
		else
		{
			error_form(result.error, $item);
		}
	});
}

function handle_topic_context_menu(action, item, pos)
{
	var $href = $(item);
	var $item = $(item).parent();
	var itemid = $item.attr("id").substring(1);
	switch (action)
	{
	case "edit":
		window.location = "<?=$this->pathTo('Topic', 'edit')?>/"+itemid;
		break;
	case "create":
		window.location = "<?=$this->pathTo('Topic', 'new')?>/"+itemid;
		break;
	case "cut":
		if (cut_topic_id) $("#t"+cut_topic_id).removeClass("cut");
		cut_topic_id = itemid;
		$item.addClass("cut");
		$(".contextMenu li.paste").removeClass("disabled");
		break;
	case "paste":
		if (cut_topic_id)
		{
			var $cutitem = $("#t"+cut_topic_id).removeClass("cut");
			var $ul = $item.find("ul:first");
			if ($ul.length == 0)
			   	$ul = $("<ul>").appendTo($item);
			$ul.append($cutitem);
			cut_topic_id = null;
			$(".contextMenu li.paste").addClass("disabled");
		}
		break;
	case "rename":
		var pos = $item.offset();
		pos.top += $href.height();
		$("#renameTopic")
			.attr("action", "<?=$this->pathTo('Topic', 'rename')?>/" + itemid)
			.css(pos)
			.find("#ttitle").val($href.text()).end()
			.find("#tname").val($href.attr("title")).end()
			.show()
			.find("#ttitle").focus();
		break;
	case "remove":
		ask_question("Точно удалить этот раздел?", $href, "<?=$this->pathTo('Topic', 'remove')?>/" + itemid, remove_topic);
		break;
	case "write":
		window.location = "<?=$this->pathTo('Article', 'new')?>/"+itemid;
		break;
	}
}

var context_menu;
function enable_context_menu(selector, menu, func)
{
	var actfunc = function(){
		var $me     = $(this);
		var $caller = $me.prev();
		var $menu   = $caller.data('menu');
		var invis   = !$me.data('menuvisible');

		if (context_menu)
		{
			context_menu.hide();
			context_menu.data('caller').next().data('menuvisible', false);
			context_menu = null;
		}

		if (invis)
		{
			var pos = $me.offset();
			pos.top += $me.height();
			$menu.data('caller', $caller).css(pos).show();
			context_menu = $menu;
			$me.data('menuvisible', true);
		}
		else
		{
			$me.data('menuvisible', false);
		}
		return false;
	};
	var menufunc = function(){
		var $me = $(this).parents("ol");
		var pos = $me.offset();
		var func = $me.data('callback');
		var $item = $me.data('caller');
		var act  = $(this).attr('href').substring(1);

		context_menu.hide();
		context_menu.data('caller').next().data('menuvisible', false);
		context_menu = null;

		func(act, $item.get(0), pos);
		return false;
	};

	var $activator = $("<a href=\"#\" class=\"menu-activator\">&#8964;<"+"/a>");
	var $menu = $(menu).data('callback', func);
	$menu.find("li > a").each(function(){$(this).click(menufunc)}).end();

	$(selector).data("menu", $menu).after($activator);
	return $(selector).not("a.menu-activator").each(function(){$(this).next().click(actfunc)}).end();
}

$("#topics ul li#troot ul").sortable({ items: 'li', handle: 'a', update: reorder_topic });
enable_context_menu("#topics ul li#troot ul li a", '#topicsMenu', handle_topic_context_menu);
enable_context_menu("#topics ul li#troot > a", '#rootTopicMenu', handle_topic_context_menu);
$("form.popupForm").submit(run_form).find("input.reset").click(function(){$(this).parents("form").hide()});
$(".errorForm").click(function(){$(this).hide()});
$("#renameTopic").data("ajaxaction", rename_topic);
//]]>
</script>
